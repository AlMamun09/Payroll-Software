@{
    ViewData["Title"] = "Leave Management";
}

<link rel="stylesheet" href="//cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css" />

<div class="card" id="leaveCard"
     data-list-url="@Url.Action("GetLeavesJson", "Leave")"
     data-create-get="@Url.Action("Create", "Leave")"
     data-edit-get-template="@Url.Action("Edit", "Leave")/"
     data-delete-template="@Url.Action("Delete", "Leave")/"
     data-approve-template="@Url.Action("Approve", "Leave")/"
     data-reject-template="@Url.Action("Reject", "Leave")/">

    <div class="card-header">
        <h3 class="card-title m-0">
            <i class="fas fa-calendar-alt mr-2"></i>Leave Management
        </h3>
        <div class="card-tools">
            <button id="btnAddLeave" class="btn btn-primary">
                <i class="fas fa-plus"></i> Apply for Leave
            </button>
        </div>
    </div>

    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-3">
                <select id="statusFilter" class="form-control">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="typeFilter" class="form-control">
                    <option value="">All Types</option>
                    <option value="Casual">Casual</option>
                    <option value="Sick">Sick</option>
                    <option value="Earned">Earned</option>
                    <option value="Unpaid">Unpaid</option>
                </select>
            </div>
        </div>

        <table id="leaveTable" class="table table-bordered table-hover w-100">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Leave Type</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Total Days</th>
                    <th>Status</th>
                    <th style="width:160px;" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded via AJAX -->
            </tbody>
        </table>
    </div>
</div>

<!-- Hidden anti-forgery form to extract token for AJAX -->
<form id="__afForm" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<!-- Modal -->
<div class="modal fade" id="leaveModal" tabindex="-1" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Leave Application</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <!-- dynamic form content loads here -->
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalTitle">Update Leave Status</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="statusLeaveId" />
                    <div class="form-group">
                        <label for="statusRemarks">Remarks</label>
                        <textarea id="statusRemarks" class="form-control" rows="3" placeholder="Enter remarks..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="btnConfirmApprove" style="display:none;">Approve</button>
                <button type="button" class="btn btn-danger" id="btnConfirmReject" style="display:none;">Reject</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="//cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>
    <script src="~/js/crud-datatable.js"></script>
    <script src="~/js/crud-modal.js"></script>

    <script>
        window.__AntiForgeryToken = document.querySelector('#__afForm input[name="__RequestVerificationToken"]').value;

        $(function () {
            const $card = $('#leaveCard');
            const listUrl = $card.data('list-url');

            // Routes for the modal and actions
            const routes = {
                createGet: $card.data('create-get'),
                editGet: (id) => $card.data('edit-get-template') + id,
                delete: (id) => $card.data('delete-template') + id,
                approve: (id) => $card.data('approve-template') + id,
                reject: (id) => $card.data('reject-template') + id
            };

            // Initialize the modal
            const leaveModal = CrudModal.init({
                modalSelector: '#leaveModal',
                addBtnSelector: '#btnAddLeave',
                routes,
                createTitle: 'Apply for Leave',
                editTitle: 'Edit Leave Application',
                onSaved: () => dataTable.ajax.reload() // Reload the table when saved
            });

            // Initialize the DataTable
            const dataTable = $('#leaveTable').DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: listUrl,
                    type: 'GET',
                    dataSrc: 'data',
                    error: function(xhr, error, thrown) {
                        console.error('DataTables Ajax Error:', xhr.responseText);
                    }
                },
                columns: [
                    { data: 'employeeId' },
                    { data: 'leaveType' },
                    {
                        data: 'startDate',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString() : '';
                        }
                    },
                    {
                        data: 'endDate',
                        render: function(data) {
                            return data ? new Date(data).toLocaleDateString() : '';
                        }
                    },
                    {
                        data: 'totalDays',
                        className: 'text-center',
                        render: function(data) {
                            return data || '0';
                        }
                    },
                    {
                        data: 'leaveStatus',
                        render: function (data) {
                            const statusClass = {
                                'Pending': 'warning',
                                'Approved': 'success',
                                'Rejected': 'danger'
                            }[data] || 'secondary';

                            return `<span class="badge badge-${statusClass}">${data}</span>`;
                        }
                    },
                    {
                        data: 'leaveId',
                        render: function(data, type, row) {
                            let buttons = `
                                <button class="btn btn-sm btn-info mr-1 js-edit" data-id="${data}" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            `;

                            if (row.leaveStatus === 'Pending') {
                                buttons += `
                                    <button class="btn btn-sm btn-success mr-1 js-approve" data-id="${data}" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger mr-1 js-reject" data-id="${data}" title="Reject">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                            }

                            buttons += `
                                <button class="btn btn-sm btn-danger js-delete" data-id="${data}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;

                            return `<div class="text-center">${buttons}</div>`;
                        },
                        orderable: false,
                        className: 'text-center'
                    }
                ],
                order: [[2, 'desc']], // Default sort by Start Date descending
                language: {
                    emptyTable: "No leave records found",
                    zeroRecords: "No matching leaves found"
                }
            });

            // Edit button handler
            $('#leaveTable').on('click', '.js-edit', function() {
                const leaveId = $(this).data('id');
                leaveModal.openEdit(leaveId);
            });

            // Delete button handler
            $('#leaveTable').on('click', '.js-delete', function() {
                const leaveId = $(this).data('id');
                if (confirm('Are you sure you want to delete this leave?')) {
                    $.ajax({
                        url: routes.delete(leaveId),
                        type: 'POST',
                        headers: {
                            'RequestVerificationToken': window.__AntiForgeryToken
                        },
                        success: function(response) {
                            dataTable.ajax.reload();
                            showToast('success', 'Leave deleted successfully!');
                        },
                        error: function(xhr) {
                            showToast('error', 'Error deleting leave: ' + xhr.responseText);
                        }
                    });
                }
            });

            // Status update functionality
            $('#leaveTable').on('click', '.js-approve', function() {
                const leaveId = $(this).data('id');
                openStatusModal(leaveId, 'approve');
            });

            $('#leaveTable').on('click', '.js-reject', function() {
                const leaveId = $(this).data('id');
                openStatusModal(leaveId, 'reject');
            });

            function openStatusModal(leaveId, action) {
                $('#statusLeaveId').val(leaveId);
                $('#statusRemarks').val('');

                if (action === 'approve') {
                    $('#statusModalTitle').text('Approve Leave');
                    $('#btnConfirmApprove').show();
                    $('#btnConfirmReject').hide();
                } else {
                    $('#statusModalTitle').text('Reject Leave');
                    $('#btnConfirmApprove').hide();
                    $('#btnConfirmReject').show();
                }

                $('#statusModal').modal('show');
            }

            $('#btnConfirmApprove').click(function() {
                updateStatus('Approved');
            });

            $('#btnConfirmReject').click(function() {
                updateStatus('Rejected');
            });

            function updateStatus(status) {
                const leaveId = $('#statusLeaveId').val();
                const remarks = $('#statusRemarks').val();
                const url = status === 'Approved' ? routes.approve(leaveId) : routes.reject(leaveId);

                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': window.__AntiForgeryToken
                    },
                    data: { remarks: remarks },
                    success: function(response) {
                        $('#statusModal').modal('hide');
                        dataTable.ajax.reload();
                        showToast('success', `Leave ${status.toLowerCase()} successfully!`);
                    },
                    error: function(xhr) {
                        showToast('error', 'Error updating leave status: ' + xhr.responseText);
                    }
                });
            }

            // Filter functionality
            $('#statusFilter, #typeFilter').change(function() {
                dataTable.ajax.reload();
            });

            // Extend the DataTable to handle filters
            dataTable.on('preXhr.dt', function(e, settings, data) {
                data.statusFilter = $('#statusFilter').val();
                data.typeFilter = $('#typeFilter').val();
            });

            function showToast(type, message) {
                // Simple alert for now - you can implement proper toast notifications
                alert(message);
            }
        });
    </script>
}