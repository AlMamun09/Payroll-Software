@{
   ViewData["Title"] = "Salary Slips";
}

<link rel="stylesheet" href="//cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css" />

<div class="card" id="salarySlipCard" data-list-url="@Url.Action("GetSalarySlipsJson", "SalarySlip")"
   data-view-url-template="@Url.Action("View", "SalarySlip")/"
   data-delete-template="@Url.Action("Delete", "SalarySlip")/">

   <div class="card-header">
      <h3 class="card-title m-0">
         <i class="fas fa-file-invoice mr-2"></i>Salary Slips
      </h3>
      <div class="card-tools">
         <a class="btn btn-primary" href="@Url.Action("Index", "Payroll")">
            <i class="fas fa-calculator"></i> Go to Payroll
         </a>
      </div>
   </div>

   <div class="card-body">
      <table id="salarySlipTable" class="table table-bordered table-hover w-100">
         <thead>
            <tr>
               <th>Employee Code</th>
               <th>Employee Name</th>
               <th>Month/Year</th>
               <th>Gross Earnings</th>
               <th>Deductions</th>
               <th>Net Pay</th>
               <th>Generated Date</th>
               <th>Status</th>
               <th style="width:120px;" class="text-center">Actions</th>
            </tr>
         </thead>
         <tbody></tbody>
      </table>
   </div>
</div>

<form id="__afForm" method="post" style="display:none;">
   @Html.AntiForgeryToken()
</form>

@section Scripts {
   <script src="//cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>
   <script>
      window.__AntiForgeryToken = document.querySelector('#__afForm input[name="__RequestVerificationToken"]').value;

      $(function () {
         const $card = $('#salarySlipCard');
         const listUrl = $card.data('list-url');
         const viewUrlTemplate = $card.data('view-url-template');
         const deleteTemplate = $card.data('delete-template');

         const table = $('#salarySlipTable').DataTable({
            ajax: {
               url: listUrl,
               dataSrc: 'data',
               dataSrc: function (json) {
                  // Update statistics
                  updateStatistics(json.data);
                  return json.data;
               }
            },
            order: [[8, 'desc']], // Sort by Generated Date descending
            columns: [
               { data: 'employeeCode' },
               { data: 'employeeName' },
               { data: 'monthYear' },
               {
                  data: 'grossEarnings',
                  render: d => d?.toFixed(2),
                  className: 'text-right'
               },
               {
                  data: 'totalDeductions',
                  render: d => d?.toFixed(2),
                  className: 'text-right'
               },
               {
                  data: 'netPay',
                  render: d => d?.toFixed(2),
                  className: 'text-right font-weight-bold'
               },
               {
                  data: 'generatedDate',
                  render: d => d ? new Date(d).toLocaleString() : ''
               },
               {
                  data: 'paymentStatus',
                  render: d => {
                     if (d === 'Paid') {
                        return '<span class="badge badge-success">Paid</span>';
                     } else {
                        return '<span class="badge badge-warning">Pending</span>';
                     }
                  }
               },
               {
                  data: 'salarySlipId',
                  render: (id, type, row) => `
                        <div class="text-center">
                           <a class="btn btn-sm btn-info mr-1" href="${viewUrlTemplate}${id}" title="View Salary Slip">
                              <i class="fas fa-eye"></i>
                           </a>
                        </div>
                        `,
                  orderable: false,
                  className: 'text-center'
               }
            ]
         });

         // Function to update statistics
         function updateStatistics(data) {
            const totalSlips = data.length;
            const paidSlips = data.filter(s => s.paymentStatus === 'Paid').length;
            const pendingSlips = totalSlips - paidSlips;

            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            const currentMonthSlips = data.filter(s => s.month === currentMonth && s.year === currentYear).length;

            $('#totalSlips').text(totalSlips);
            $('#paidSlips').text(paidSlips);
            $('#pendingSlips').text(pendingSlips);
            $('#currentMonth').text(currentMonthSlips);
         }


      });
   </script>
}