@model PayrollSoftware.Infrastructure.Application.DTOs.AttendanceDto
@{
    Layout = null;
    ViewData["Title"] = ViewBag?.Title ?? "Attendance Entry";
    var formAction = ViewBag?.FormAction as string ?? (Model?.AttendanceId != Guid.Empty ? Url.Action("Edit", "Attendance") : Url.Action("Create", "Attendance"));
    var isEdit = Model?.AttendanceId != Guid.Empty;
}

<!-- Select2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<div class="p-3">
    <form id="attendanceForm" method="post" action="@formAction">
        @Html.AntiForgeryToken()

        @if (isEdit)
        {
            <input type="hidden" asp-for="AttendanceId" />
        }

        <div class="row">
            <div class="form-group col-md-6">
                <label asp-for="EmployeeId">Employee ID</label>
                <select asp-for="EmployeeId" class="form-control select2" id="EmployeeId" data-placeholder="Select Employee ID" style="width:100%;">
                    <option value="">-- select --</option>
                    @if (ViewBag.Employees != null)
                    {
                        foreach (var e in (IEnumerable<dynamic>)ViewBag.Employees)
                        {
                            <option value="@e.EmployeeId"
                                    data-name="@e.FullName"
                                    selected="@(Model?.EmployeeId == (Guid)e.EmployeeId)">
                                @e.EmployeeCode
                            </option>
                        }
                    }
                </select>
                <span asp-validation-for="EmployeeId" class="text-danger"></span>
            </div>

            <div class="form-group col-md-6">
                <label>Employee Name</label>
                <input id="EmployeeName" class="form-control" readonly placeholder="Select Employee ID first" />
                <small class="form-text text-muted">Auto-populated based on Employee ID.</small>
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label asp-for="AttendanceDate">Attendance Date</label>
                <input type="date" asp-for="AttendanceDate" class="form-control" id="AttendanceDate"
                       max="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                <span asp-validation-for="AttendanceDate" class="text-danger"></span>
            </div>

            <div class="form-group col-md-6">
                <label>Day of Week</label>
                <input id="DayOfWeek" class="form-control" readonly />
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label asp-for="InTime">In Time</label>
                <input type="time" asp-for="InTime" class="form-control" id="InTime" />
                <span asp-validation-for="InTime" class="text-danger"></span>
            </div>

            <div class="form-group col-md-6">
                <label asp-for="OutTime">Out Time</label>
                <input type="time" asp-for="OutTime" class="form-control" id="OutTime" />
                <span asp-validation-for="OutTime" class="text-danger"></span>
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-4">
                <label asp-for="Status">Status</label>
                <input type="text" asp-for="Status" class="form-control" id="Status" readonly />
                <small class="form-text text-muted">Auto-calculated</small>
            </div>

            <div class="form-group col-md-4">
                <label asp-for="WorkingHours">Working Hours</label>
                <input type="text" asp-for="WorkingHours" class="form-control" id="WorkingHours" readonly />
            </div>

        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label asp-for="LateEntry">Late Entry (mins)</label>
                <input type="text" asp-for="LateEntry" class="form-control" id="LateEntry" readonly />
            </div>

            <div class="form-group col-md-6">
                <label asp-for="EarlyLeave">Early Leave (mins)</label>
                <input type="text" asp-for="EarlyLeave" class="form-control" id="EarlyLeave" readonly />
            </div>
        </div>

        <div class="text-right">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Save</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
    </form>
</div>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    (function () {
        // Initialize Select2 for EmployeeId dropdown
        $('#EmployeeId').select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Select Employee ID',
            allowClear: true,
            dropdownParent: $('#attendanceModal')
        });

        // Handle Employee selection – populate name
        const empNameEl = document.getElementById('EmployeeName');

        $('#EmployeeId').on('select2:select', function (e) {
            const selectedOption = e.params.data.element;
            const empName = selectedOption.getAttribute('data-name') || '';
            if (empNameEl) empNameEl.value = empName;
            calculateAttendance();
        });

        $('#EmployeeId').on('select2:clear', function () {
            if (empNameEl) empNameEl.value = '';
        });

        // Set initial employee name if editing
        const selectedEmp = $('#EmployeeId option:selected');
        if (selectedEmp.length && selectedEmp.val()) {
            const empName = selectedEmp.attr('data-name') || '';
            if (empNameEl) empNameEl.value = empName;
        }

        // Form elements
        const form = document.getElementById('attendanceForm');
        const dateEl = document.getElementById('AttendanceDate');
        const inTimeEl = document.getElementById('InTime');
        const outTimeEl = document.getElementById('OutTime');
        const statusEl = document.getElementById('Status');
        const workingHoursEl = document.getElementById('WorkingHours');
        const overtimeEl = document.getElementById('OvertimeHours');
        const lateEntryEl = document.getElementById('LateEntry');
        const earlyLeaveEl = document.getElementById('EarlyLeave');
        const dayOfWeekEl = document.getElementById('DayOfWeek');

        // Company working hours (adjust as needed)
        const COMPANY_START_TIME = '09:00';
        const COMPANY_END_TIME = '17:00';
        const REGULAR_HOURS = 8;

        // Calculate day of week
        function updateDayOfWeek() {
            if (!dateEl?.value) return;
            const date = new Date(dateEl.value);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            if (dayOfWeekEl) dayOfWeekEl.value = days[date.getDay()];
        }

        // Calculate attendance details
        function calculateAttendance() {
            updateDayOfWeek();

            const inTime = inTimeEl?.value;
            const outTime = outTimeEl?.value;

            // Reset all fields
            if (statusEl) statusEl.value = '';
            if (workingHoursEl) workingHoursEl.value = '';
            if (overtimeEl) overtimeEl.value = '';
            if (lateEntryEl) lateEntryEl.value = '';
            if (earlyLeaveEl) earlyLeaveEl.value = '';

            if (!inTime && !outTime) {
                if (statusEl) statusEl.value = 'Absent';
                return;
            }

            if (inTime && outTime) {
                // Calculate working hours
                const inDate = new Date(`1970-01-01T${inTime}:00`);
                const outDate = new Date(`1970-01-01T${outTime}:00`);

                let diffHours = (outDate - inDate) / (1000 * 60 * 60);
                if (diffHours < 0) diffHours += 24; // overnight shift

                if (workingHoursEl) workingHoursEl.value = diffHours.toFixed(2);

                // Calculate overtime
                const regularHours = Math.min(diffHours, REGULAR_HOURS);
                const overtime = Math.max(0, diffHours - REGULAR_HOURS);
                if (overtimeEl) overtimeEl.value = overtime.toFixed(2);

                // Calculate late entry
                const companyStart = new Date(`1970-01-01T${COMPANY_START_TIME}:00`);
                const actualStart = new Date(`1970-01-01T${inTime}:00`);
                const lateMinutes = Math.max(0, (actualStart - companyStart) / (1000 * 60));
                if (lateEntryEl) lateEntryEl.value = Math.round(lateMinutes);

                // Calculate early leave
                const companyEnd = new Date(`1970-01-01T${COMPANY_END_TIME}:00`);
                const actualEnd = new Date(`1970-01-01T${outTime}:00`);
                const earlyMinutes = Math.max(0, (companyEnd - actualEnd) / (1000 * 60));
                if (earlyLeaveEl) earlyLeaveEl.value = Math.round(earlyMinutes);

                // Determine status
                let status = 'Present';
                if (lateMinutes > 0) status = 'Late';
                if (diffHours < (REGULAR_HOURS / 2)) status = 'Half Day';

                if (statusEl) statusEl.value = status;
            } else if (inTime && !outTime) {
                // Only in time recorded
                if (statusEl) statusEl.value = 'Present';
                if (workingHoursEl) workingHoursEl.value = '0';

                // Calculate late entry
                const companyStart = new Date(`1970-01-01T${COMPANY_START_TIME}:00`);
                const actualStart = new Date(`1970-01-01T${inTime}:00`);
                const lateMinutes = Math.max(0, (actualStart - companyStart) / (1000 * 60));
                if (lateEntryEl) lateEntryEl.value = Math.round(lateMinutes);
            }
        }

        // Event listeners
        dateEl?.addEventListener('change', calculateAttendance);
        inTimeEl?.addEventListener('change', calculateAttendance);
        outTimeEl?.addEventListener('change', calculateAttendance);

        // Ensure calculation before submit
        form?.addEventListener('submit', function () {
            calculateAttendance();
        });

        // Initial setup
        updateDayOfWeek();
        calculateAttendance();
    })();
</script>