@{
  ViewData["Title"] = "Payroll Processing";
}
<link rel="stylesheet" href="//cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css" />
<div class="card" id="payrollCard" data-list-url="@Url.Action("GetPayrollsJson", "Payroll")"
  data-process-url="@Url.Action("Process", "Payroll")" data-markpaid-url-template="@Url.Action("MarkPaid", "Payroll")/">
  <div class="card-header">
    <h3 class="card-title m-0"><i class="fas fa-calculator mr-2"></i>Payroll Processing</h3>
    <div class="card-tools">
    </div>
  </div>
  <div class="card-body">
    <form id="processForm" class="form-inline mb-3">
      <div class="form-group mr-2">
        <label class="mr-2">Employee</label>
        <select id="employeeSelect" name="employeeId" class="form-control" style="min-width:220px"></select>
      </div>
      <div class="form-group mr-2">
        <label class="mr-2">Month</label>
        <input type="month" name="payrollMonth" id="payrollMonth" class="form-control" required />
      </div>
      <button type="submit" class="btn btn-success"><i class="fas fa-cogs"></i> Run Payroll</button>
    </form>

    <div class="row mb-3">
      <div class="col-md-3">
        <label for="monthFilter">Filter by Month</label>
        <input type="month" id="monthFilter" class="form-control" />
      </div>
      <div class="col-md-3">
        <label>&nbsp;</label>
        <button id="btnClearFilter" class="btn btn-secondary btn-block">Show All</button>
      </div>
    </div>

    <table id="payrollTable" class="table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th>Employee Code</th>
          <th>Employee Name</th>
          <th>Month</th>
          <th>Basic</th>
          <th>Allowances</th>
          <th>Deductions</th>
          <th>Net</th>
          <th>Status</th>
          <th>Paid Date</th>
          <th style="width:120px" class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<form id="__afForm" method="post" style="display:none;">@Html.AntiForgeryToken()</form>
@section Scripts {
  <script src="//cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>
  <script>
    window.__AntiForgeryToken = document.querySelector('#__afForm input[name="__RequestVerificationToken"]').value;
    $(function () {
      const listUrl = $('#payrollCard').data('list-url');
      const processUrl = $('#payrollCard').data('process-url');
      const markPaidTemplate = $('#payrollCard').data('markpaid-url-template');

      const table = $('#payrollTable').DataTable({
        ajax: {
          url: listUrl,
          data: function (d) {
            d.monthFilter = $('#monthFilter').val();
          },
          dataSrc: 'data'
        },
        columns: [
          { data: 'employeeCode' },
          { data: 'employeeName' },
          {
            data: 'payPeriodStart',
            render: (d) => {
              if (!d) return '';
              const date = new Date(d);
              return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            }
          },
          { data: 'basicSalary', render: d => d?.toFixed(2) },
          { data: 'totalAllowances', render: d => d?.toFixed(2) },
          { data: 'totalDeductions', render: d => d?.toFixed(2) },
          { data: 'netSalary', render: d => d?.toFixed(2) },
          {
            data: 'paymentStatus',
            render: (status) => {
              const badgeClass = status === 'Paid' ? 'badge-success' : 'badge-warning';
              return `<span class="badge ${badgeClass}">${status}</span>`;
            }
          },
          { data: 'paymentDate', render: d => d ? new Date(d).toLocaleDateString() : '-' },
          {
            data: 'payrollId',
            render: (id, type, row) => {
              const paidBtn = row.paymentStatus === 'Paid' ? '' : `<button class="btn btn-sm btn-success js-paid" data-id="${id}" title="Mark Paid"><i class="fas fa-dollar-sign"></i></button>`;

              return `<div class="text-center">
                  <a class="btn btn-sm btn-info mr-1" href="@Url.Action("Details", "Payroll")/${id}" title="Details"><i class="fas fa-info-circle"></i></a>
                  ${paidBtn}
                 </div>`;
            },
            orderable: false,
            className: 'text-center'
          }
        ],
        order: [[2, 'desc']]
      });

      // Load employees for selection
      $.get('@Url.Action("GetEmployeesJson", "Employee")', function (r) {
        const sel = $('#employeeSelect');
        sel.append('<option value="">-- Select Employee --</option>');
        r.data.forEach(e => sel.append(`<option value="${e.employeeId}">${e.employeeCode} - ${e.fullName}</option>`));
      });

      // Set default month to current month
      const now = new Date();
      const currentMonth = now.toISOString().substring(0, 7);
      $('#payrollMonth').val(currentMonth);
      $('#monthFilter').val(currentMonth);

      // Process payroll form submission
      $('#processForm').on('submit', function (e) {
        e.preventDefault();
        const employeeId = $('#employeeSelect').val();
        const payrollMonth = $('#payrollMonth').val();

        if (!employeeId) {
          Swal.fire({
            icon: 'warning',
            title: 'Validation Error',
            text: 'Please select an employee',
            confirmButtonColor: '#3085d6'
          });
          return;
        }

        if (!payrollMonth) {
          Swal.fire({
            icon: 'warning',
            title: 'Validation Error',
            text: 'Please select a month',
            confirmButtonColor: '#3085d6'
          });
          return;
        }

        Swal.fire({
          title: 'Processing...',
          text: 'Please wait while we process the payroll',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        $.ajax({
          url: processUrl,
          method: 'POST',
          headers: { 'RequestVerificationToken': window.__AntiForgeryToken },
          data: { employeeId, payrollMonth }
        }).done(r => {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: r.message,
            confirmButtonColor: '#3085d6',
            timer: 2000,
            timerProgressBar: true
          });
          table.ajax.reload();
          $('#employeeSelect').val('');
        })
          .fail(x => {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: x.responseJSON?.message || 'Failed to process payroll',
              confirmButtonColor: '#3085d6'
            });
          });
      });

      // Month filter change handler
      $('#monthFilter').change(function () {
        table.ajax.reload();
      });

      // Clear filter button handler
      $('#btnClearFilter').click(function () {
        $('#monthFilter').val('');
        table.ajax.reload();
      });

      // Mark as paid button handler
      $('#payrollTable').on('click', '.js-paid', function () {
        const id = $(this).data('id');
        Swal.fire({
          title: 'Mark as Paid?',
          text: 'This will generate a salary slip and cannot be undone',
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Yes, Mark as Paid',
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: markPaidTemplate + id,
              method: 'POST',
              headers: { 'RequestVerificationToken': window.__AntiForgeryToken }
            })
              .done(r => {
                if (r.redirectUrl) {
                  window.location.href = r.redirectUrl;
                } else {
                  Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: r.message,
                    confirmButtonColor: '#3085d6',
                    timer: 2000,
                    timerProgressBar: true
                  });
                  table.ajax.reload();
                }
              })
              .fail(x => Swal.fire({
                icon: 'error',
                title: 'Error',
                text: x.responseJSON?.message || 'Failed to mark as paid',
                confirmButtonColor: '#3085d6'
              }));
          }
        });
      });
    });
  </script>
}