@model PayrollSoftware.Infrastructure.Application.DTOs.EmployeeDto
@{
    ViewData["Title"] = ViewBag?.Title ?? "Employee";
    var formAction = ViewBag?.FormAction as string ?? Url.Action("Create", "Employee");
}

<!-- Select2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

<div class="card">
    <div class="card-header">
        <h3 class="card-title m-0">
            <i class="fas fa-user mr-2"></i>@ViewData["Title"]
        </h3>
    </div>
    <div class="card-body">
        <form id="employeeForm" method="post" action="@formAction">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="EmployeeId" />
            <div class="row">
                <div class="form-group col-md-6">
                    <label asp-for="FullName"></label>
                    <input asp-for="FullName" class="form-control" />
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="Gender"></label>
                    <select asp-for="Gender" class="form-control select2" id="Gender"
                            data-placeholder="Select Gender" style="width:100%;">
                        <option value="">-- select --</option>
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="Status"></label>
                    <select asp-for="Status" class="form-control select2" id="Status"
                            data-placeholder="Select Status" style="width:100%;">
                        <option value="">-- select --</option>
                    </select>
                </div>

                <div class="form-group col-md-3">
                    <label asp-for="DateOfBirth"></label>
                    <input asp-for="DateOfBirth" type="date" class="form-control" />
                </div>
                <div class="form-group col-md-2">
                    <label>Age</label>
                    <input id="Age" class="form-control" readonly />
                </div>
                <div class="form-group col-md-3">
                    <label asp-for="JoiningDate"></label>
                    <input asp-for="JoiningDate" type="date" class="form-control" />
                </div>
                <div class="form-group col-md-4">
                    <label asp-for="BasicSalary"></label>
                    <input asp-for="BasicSalary" type="number" min="0" class="form-control" />
                </div>

                <div class="form-group col-md-4">
                    <label asp-for="Department">Department</label>
                    <select asp-for="Department" class="form-control select2" id="Department"
                            data-placeholder="Select Department" style="width:100%;">
                        <option value="">-- select --</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label asp-for="Designation">Designation</label>
                    <select asp-for="Designation" class="form-control select2" id="Designation"
                            data-placeholder="Select Designation" style="width:100%;">
                        <option value="">-- select --</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label asp-for="ShiftId">Shift</label>
                    <select asp-for="ShiftId" class="form-control select2" style="width:100%;"
                            data-placeholder="Select Shift"
                            asp-items="new SelectList((IEnumerable<PayrollSoftware.Infrastructure.Domain.Entities.Shift>)ViewBag.Shifts, nameof(PayrollSoftware.Infrastructure.Domain.Entities.Shift.ShiftId), nameof(PayrollSoftware.Infrastructure.Domain.Entities.Shift.ShiftName))">
                        <option value="">-- Select --</option>
                    </select>
                </div>

                <div class="form-group col-md-4">
                    <label asp-for="EmploymentType">Employment Type</label>
                    <select asp-for="EmploymentType" class="form-control select2" id="EmploymentType"
                            data-placeholder="Select Employment Type" style="width:100%;">
                        <option value="">-- select --</option>
                    </select>
                </div>

                <div class="form-group col-md-4">
                    <label asp-for="PaymentSystem"></label>
                    <select asp-for="PaymentSystem" class="form-control select2" id="PaymentSystem"
                            data-placeholder="Select Payment System" style="width:100%;">
                        <option value="">-- select --</option>
                    </select>
                </div>
                <div class="form-group col-md-4 d-none" id="MobileNumberGroup">
                    <label asp-for="MobileNumber"></label>
                    <input asp-for="MobileNumber" class="form-control" id="MobileNumber" />
                </div>

                <div class="form-group col-md-4 bank-only d-none">
                    <label asp-for="AccountHolderName"></label>
                    <input asp-for="AccountHolderName" class="form-control" />
                </div>
                <div class="form-group col-md-4 bank-only d-none">
                    <label asp-for="BankAndBranchName"></label>
                    <input asp-for="BankAndBranchName" class="form-control" />
                </div>
                <div class="form-group col-md-4 bank-only d-none">
                    <label asp-for="BankAccountNumber"></label>
                    <input asp-for="BankAccountNumber" class="form-control" />
                </div>
            </div>
            <div class="text-right">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save mr-1"></i> Save</button>
                <a class="btn btn-secondary" href="@Url.Action("Index", "Employee")">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize all Select2 dropdowns using common function
        CommonAjax.initSelect2('.select2');

        // Payment system conditional fields
        function togglePayment() {
            const v = $('#PaymentSystem').val();
            console.log('Payment System changed to:', v); // Debug log

            const showBank = v === 'Bank Transfer';
            const showMobile = v === 'Mobile Banking';

            // Hide/show bank fields
            if (showBank) {
                $('.bank-only').removeClass('d-none');
            } else {
                $('.bank-only').addClass('d-none');
            }

            // Hide/show mobile field
            if (showMobile) {
                $('#MobileNumberGroup').removeClass('d-none');
            } else {
                $('#MobileNumberGroup').addClass('d-none');
            }
        }

        // Attach event handlers BEFORE loading data
        $('#PaymentSystem').on('change select2:select', togglePayment);

        // Load lookup values for dynamic dropdowns
        CommonAjax.loadLookup('Gender', '#Gender', '@Model?.Gender');
        CommonAjax.loadLookup('Status', '#Status', '@Model?.Status');
        CommonAjax.loadLookup('EmploymentType', '#EmploymentType', '@Model?.EmploymentType');

        // Load PaymentSystem and trigger toggle AFTER loading
        CommonAjax.loadLookup('PaymentSystem', '#PaymentSystem', '@Model?.PaymentSystem').done(function() {
            // Trigger toggle after lookup is loaded
            setTimeout(togglePayment, 100);
        });

        CommonAjax.loadDepartments('#Department', '@Model?.Department');
        CommonAjax.loadDesignations('#Designation', '@Model?.Designation');
    </script>

    <script>
        const dobEl = document.getElementById('DateOfBirth');
        const ageEl = document.getElementById('Age');

        function calcAge() {
            const v = dobEl?.value;
            if (!v) {
                ageEl.value = '';
                return;
            }

            // Use common age calculation function
            const age = CommonAjax.calculateAge(v);
            ageEl.value = isNaN(age) ? '' : age;
        }

        dobEl?.addEventListener('change', calcAge);
        calcAge();

        // Use common form submission handler
        const form = document.getElementById('employeeForm');
        CommonAjax.submitForm(form, {
            successTitle: 'Success',
            errorTitle: 'Validation Error',
            onSuccess: function (data) {
                window.location.href = '@Url.Action("Index", "Employee")';
            }
        });
    </script>
}