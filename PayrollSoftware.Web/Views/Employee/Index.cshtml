@{
  ViewData["Title"] = "Employees";
}

<link rel="stylesheet" href="//cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css" />

<div class="card" id="employeeCard" data-list-url="@Url.Action("GetEmployeesJson", "Employee")"
  data-create-get="@Url.Action("Create", "Employee")" data-edit-url-template="@Url.Action("Edit", "Employee")/"
  data-details-url-template="@Url.Action("Details", "Employee")/"
  data-toggle-status-template="@Url.Action("ToggleStatus", "Employee")/">

  <div class="card-header">
    <h3 class="card-title m-0">
      <i class="fas fa-users mr-2"></i>Employees
    </h3>
    <div class="card-tools">
      <a class="btn btn-primary" href="@Url.Action("Create", "Employee")">
        <i class="fas fa-plus"></i> Add Employee
      </a>
    </div>
  </div>

  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-3">
        <select id="statusFilter" class="form-control">
          <option value="">All Status</option>
          <option value="Active" selected>Active</option>
          <option value="Inactive">Inactive</option>
          <option value="Resigned">Resigned</option>
        </select>
      </div>
    </div>

    <table id="employeeTable" class="table table-bordered table-hover w-100">
      <thead>
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Gender</th>
          <th>DOB</th>
          <th>Department</th>
          <th>Designation</th>
          <th>Status</th>
          <th style="width:160px;" class="text-center">Actions</th>
        </tr>
      </thead>
    </table>
  </div>
</div>

<form id="__afForm" method="post" style="display:none;">
  @Html.AntiForgeryToken()
</form>

@section Scripts {
  <script src="//cdn.datatables.net/2.3.4/js/dataTables.min.js"></script>

  <script>
    window.__AntiForgeryToken = document.querySelector('#__afForm input[name="__RequestVerificationToken"]').value;

    $(function () {
      const $card = $('#employeeCard');
      const listUrl = $card.data('list-url');
      const editUrlTemplate = $card.data('edit-url-template');
      const detailsUrlTemplate = $card.data('details-url-template');
      const toggleStatusTemplate = $card.data('toggle-status-template');

      // Initialize DataTable
      const dataTable = $('#employeeTable').DataTable({
        processing: true,
        serverSide: false,
        ajax: {
          url: listUrl,
          type: 'GET',
          data: function (d) {
            d.statusFilter = $('#statusFilter').val();
          },
          dataSrc: 'data',
          error: function (xhr, error, thrown) {
            console.error('DataTables Ajax Error:', xhr.responseText);
          }
        },
        columns: [
          { data: 'employeeCode' },
          { data: 'fullName' },
          { data: 'gender' },
          {
            data: 'dateOfBirth',
            render: d => d ? new Date(d).toLocaleDateString() : ''
          },
          { data: 'departmentName', defaultContent: '-' },
          { data: 'designationName', defaultContent: '-' },
          {
            data: 'status',
            render: d => {
              if (d === 'Active') {
                return '<span class="badge badge-success">Active</span>';
              } else if (d === 'Inactive') {
                return '<span class="badge badge-danger">Inactive</span>';
              } else if (d === 'Resigned') {
                return '<span class="badge badge-secondary">Resigned</span>';
              } else {
                return '<span class="badge badge-light">Unknown</span>';
              }
            }
          },
          {
            data: 'employeeId',
            orderable: false,
            className: 'text-center',
            render: (id, type, row) => {
              const isActive = row.status === 'Active';
              const statusBtnClass = isActive ? 'btn-danger' : 'btn-success';
              const statusIcon = isActive ? 'fa-toggle-off' : 'fa-toggle-on';
              const statusTitle = isActive ? 'Deactivate' : 'Activate';

              return `
                <a class="btn btn-sm btn-info mr-1" href="${detailsUrlTemplate}${id}" title="View Details">
                  <i class="fas fa-info-circle"></i>
                </a>
               <a class="btn btn-sm btn-primary mr-1" href="${editUrlTemplate}${id}" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <button class="btn btn-sm ${statusBtnClass} js-toggle-status"
                  data-id="${id}"
                  data-status="${row.status}"
                  title="${statusTitle}">
                  <i class="fas ${statusIcon}"></i>
                </button>
             `;
            }
          }
        ],
        order: [[0, 'asc']],
        language: {
          emptyTable: "No employees found",
          zeroRecords: "No matching employees found"
        }
      });

      // Toggle status button handler with SweetAlert
      $('#employeeTable').on('click', '.js-toggle-status', function () {
        const employeeId = $(this).data('id');
        const currentStatus = $(this).data('status');
        const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
        const action = currentStatus === 'Active' ? 'deactivate' : 'activate';

        Swal.fire({
          title: `${action === 'deactivate' ? 'Deactivate' : 'Activate'} Employee?`,
          text: `This employee will be marked as ${newStatus}`,
          icon: action === 'deactivate' ? 'warning' : 'question',
          showCancelButton: true,
          confirmButtonColor: action === 'deactivate' ? '#6c757d' : '#28a745',
          cancelButtonColor: action === 'deactivate' ? '#3085d6' : '#6c757d',
          confirmButtonText: `Yes, ${action} it!`,
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: toggleStatusTemplate + employeeId,
              type: 'POST',
              headers: {
                'RequestVerificationToken': window.__AntiForgeryToken
              },
              success: function (response) {
                Swal.fire({
                  icon: 'success',
                  title: `${action === 'deactivate' ? 'Deactivated' : 'Activated'}!`,
                  text: response.message || `Employee ${action}d successfully!`,
                  confirmButtonColor: '#3085d6',
                  timer: 2000,
                  timerProgressBar: true
                });
                dataTable.ajax.reload();
              },
              error: function (xhr) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: xhr.responseJSON?.message || `Error ${action}ing employee`,
                  confirmButtonColor: '#3085d6'
                });
              }
            });
          }
        });
      });

      // Status filter change handler
      $('#statusFilter').change(function () {
        dataTable.ajax.reload();
      });

      // Extend DataTable to handle status filter
      dataTable.on('preXhr.dt', function (e, settings, data) {
        data.statusFilter = $('#statusFilter').val();
      });
    });
  </script>
}